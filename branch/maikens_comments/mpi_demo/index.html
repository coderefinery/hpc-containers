<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running Parallel Jobs &mdash; Container on HPC with Apptainer  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />

  
    <link rel="shortcut icon" href="../_static/coderefinery.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Container on HPC with Apptainer
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro_and_motivation/">Intro to containers (on HPC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics_running_containers/">Basics of running containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../container_images/">Intro to container images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building_images/">Building Apptainer images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../binding_folders/">Binding folders into your container</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extras</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gpus/">Running containers that use GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services_apps/">Services and apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips_tricks/">Tips, tricks and frequently asked questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exercises</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../verify_installation/">Verify Apptainer Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first_build/">Building Your First Container</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Container on HPC with Apptainer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Running Parallel Jobs</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/coderefinery/ttt4hpc_containers/blob/main/ttt4hpc_containers/content/mpi_demo.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-parallel-jobs">
<h1>Running Parallel Jobs<a class="headerlink" href="#running-parallel-jobs" title="Permalink to this heading"></a></h1>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand the integration of MPI with containerized environments.</p></li>
<li><p>Learn to execute a script that runs parallel computational jobs using MPI inside an Apptainer container.</p></li>
<li><p>Acquire skills to leverage HPC resources for parallel computing within containerized applications.</p></li>
</ul>
<p>This demo demonstrates how to run parallel computational jobs inside an Apptainer container using the Message Passing Interface (MPI). Parallel computing is essential in HPC for solving complex and large-scale problems efficiently. By running these jobs inside containers, you can enhance portability and reproducibility of your computations across different HPC systems. This example will guide you through setting up an MPI environment inside a container and executing a parallel job script.</p>
</div>
<div class="admonition-prerequisites prerequisites admonition" id="prerequisites-0">
<p class="admonition-title">Prerequisites</p>
<ul class="simple">
<li><p>Access to an HPC system with Apptainer installed.</p></li>
<li><p>Basic knowledge of parallel computing and MPI.</p></li>
<li><p>User permissions to run jobs on the HPC cluster.</p></li>
</ul>
</div>
<p>Containers can encapsulate all the necessary software and libraries, providing a consistent runtime environment for applications. This is particularly beneficial for parallel computing where environmental consistency can significantly affect computational results. In this demo, you will use Apptainer to encapsulate the MPI environment and ensure that your parallel jobs can be executed seamlessly on any HPC system.</p>
<p>First, you will create a definition file for an Apptainer container that includes MPI libraries and a simple MPI script. Then, you will build the container and run a parallel job using MPI.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apptainer definition file for MPI environment</span>
Bootstrap:<span class="w"> </span>library
From:<span class="w"> </span>ubuntu:20.04

%post
<span class="w">    </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>mpich
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello from MPI&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;#include &lt;mpi.h&gt;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;int main(int argc, char* argv[]) {&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    MPI_Init(&amp;argc, &amp;argv);&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    int rank;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    printf(\&quot;Rank %d: Hello MPI World!\\n\&quot;, rank);&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    MPI_Finalize();&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;    return 0;&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;}&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/mpi_test.c
<span class="w">    </span>mpicc<span class="w"> </span>/mpi_test.c<span class="w"> </span>-o<span class="w"> </span>/mpi_hello

%environment
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/bin:<span class="nv">$PATH</span>

%runscript
<span class="w">    </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>/mpi_hello
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the MPI container</span>
apptainer<span class="w"> </span>build<span class="w"> </span>mpi_container.sif<span class="w"> </span>mpi.def
</pre></div>
</div>
<p>This block creates the container <code class="docutils literal notranslate"><span class="pre">mpi_container.sif</span></code> from the definition file <code class="docutils literal notranslate"><span class="pre">mpi.def</span></code>. It includes installing MPICH, a popular MPI implementation, and compiling a simple MPI program that will be executed within the container.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the MPI container job</span>
apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--nv<span class="w"> </span>mpi_container.sif<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>/mpi_hello
</pre></div>
</div>
<p>This command runs the MPI program inside the container across four processes. The <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option allows the container to access the host’s Nvidia GPU resources if available, which is useful for MPI jobs that may benefit from GPU acceleration.</p>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading"></a></h2>
<p>You have successfully learned how to set up and execute parallel computational jobs using MPI inside an Apptainer container. This ability is critical for ensuring that your scientific computing tasks are both scalable and reproducible, regardless of the underlying HPC infrastructure. By encapsulating the MPI environment inside a container, you maintain consistency and control over the software dependencies, significantly enhancing the reliability of your computational results.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024-, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>